name: Deploy to Plugin Repository

on:
  workflow_dispatch:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/checkout@v2
        with:
          path: Alexr03.Common
          repository: Alexr03/Common
      - uses: actions/checkout@v2
        with:
          path: Alexr03.Common.TCAdmin
          repository: Alexr03/Common.TCAdmin
      - name: PowerShell script
        uses: Amadevus/pwsh-script@v2.0.0
        with:
          script: |
            Move-Item -Path Alexr03.Common -Destination ..
            Move-Item -Path Alexr03.Common.TCAdmin -Destination ..
      - name: setup-msbuild
        uses: microsoft/setup-msbuild@v1
        env:
          ACTIONS_ALLOW_UNSECURE_COMMANDS: true
      - name: Nuget Restore
        run: |
          nuget sources add -name TCAdmin -Source https://nexus-repository.openshift.alexr03.dev/repository/tcadmin-group/index.json
          nuget restore -PackagesDirectory ../packages
      - name: Build using .NET 4.7.2
        run: msbuild TCAdminCustomMods.csproj
#       - name: Delete latest release
#         uses: ame-yu/action-delete-latest-release@v2
#         with:
#           github_token: ${{ secrets.GITHUB_TOKEN }}
#       - name: Create a Release
#         id: create_release
#         uses: actions/create-release@v1.1.4
#         env:
#           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#         with:
#           tag_name: REL_${{ github.ref}}
#           release_name: Release v1.0.2
#       - name: Upload Release Asset
#         id: upload-release-asset 
#         uses: actions/upload-release-asset@v1
#         env:
#           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#         with:
#           upload_url: ${{ steps.create_release.outputs.upload_url }} # This pulls from the CREATE RELEASE step above, referencing it's ID to get its outputs object, which include a `upload_url`. See this blog post for more info: https://jasonet.co/posts/new-features-of-github-actions/#passing-data-to-future-steps 
#           asset_path: output.zip
#           asset_name: output.zip
#           asset_content_type: application/zip
#       - uses: alexr03/ips-resource-updater@master
#         with:
#           ips_url: https://community.tcadmin.com
#           api_key: ${{ secrets.IPS_API_KEY }}
#           resource_id: 81
#           file_name: 'output.zip'
#           file_url: ${{steps.upload-release-asset.outputs.browser_download_url}}
#           version: '1.0.2'
#           changelog: ''
#           save_previous: true
